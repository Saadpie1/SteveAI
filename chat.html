<!-- chat.html -->
<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Steve AI Chat</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
  <style>
    body { background-color: #0d0f0d; color: #e0fce1; font-family: 'Segoe UI', sans-serif; }
    .chat-bubble img { max-width: 100%; border-radius: 8px; }
    .avatar { font-size: 1.5rem; margin-right: 8px; }
  </style>
</head>
<body class="flex flex-col min-h-screen">
  <!-- Header -->
  <div class="flex items-center justify-between px-4 py-3 border-b border-green-800 bg-green-950">
    <div class="text-2xl text-green-400 font-bold">üåø SteveAI Chat</div>
    <div class="flex gap-3">
      <button id="exportBtn" class="text-sm bg-green-700 text-white px-3 py-1 rounded hover:bg-green-600">üìú Export</button>
      <button id="logoutBtn" class="text-sm bg-red-600 text-white px-3 py-1 rounded hover:bg-red-500">üîê Logout</button>
    </div>
  </div>

  <!-- Chat Display -->
  <div id="chatBox" class="flex-1 overflow-y-auto p-4 space-y-4 flex flex-col"></div>

  <!-- Input Area -->
  <div class="p-4 flex gap-2 border-t border-green-900 bg-green-950">
    <textarea id="inputBox" rows="1" placeholder="Ask SteveAI anything..." class="flex-1 p-3 bg-green-900 text-white rounded resize-none"></textarea>
    <button id="sendBtn" class="bg-green-500 hover:bg-green-400 text-white px-4 py-2 rounded">Send</button>
  </div>

  <!-- Firebase & Logic -->
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/12.0.0/firebase-app.js";
    import { getFirestore, collection, addDoc, query, orderBy, onSnapshot, getDocs } from "https://www.gstatic.com/firebasejs/12.0.0/firebase-firestore.js";
    import { getAuth, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/12.0.0/firebase-auth.js";

    const firebaseConfig = {
      apiKey: "AIzaSyCUic123GTi1M82hV_7txQ8xTbBVfjn3r8",
      authDomain: "steveai-f4a56.firebaseapp.com",
      projectId: "steveai-f4a56",
      storageBucket: "steveai-f4a56.appspot.com",
      messagingSenderId: "852076577383",
      appId: "1:852076577383:web:631149327a19283d750ac2"
    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);
    const auth = getAuth(app);

    const chatBox = document.getElementById("chatBox");
    const inputBox = document.getElementById("inputBox");
    const sendBtn = document.getElementById("sendBtn");
    const logoutBtn = document.getElementById("logoutBtn");
    const exportBtn = document.getElementById("exportBtn");

    let userId = null;
    let messages = [];

    function addMessageBubble(msg) {
      const bubble = document.createElement("div");
      const avatar = msg.from === "user" ? "üßë" : "ü§ñ";
      const alignment = msg.from === "user" ? "self-end bg-green-700" : "self-start bg-gray-700";
      bubble.className = `chat-bubble max-w-xl p-3 rounded-xl flex items-start ${alignment} text-white`;
      bubble.innerHTML = `<div class="avatar">${avatar}</div><div class="content">${marked.parse(msg.text)}</div>`;
      chatBox.appendChild(bubble);
      chatBox.scrollTop = chatBox.scrollHeight;
    }

    onAuthStateChanged(auth, (user) => {
      if (!user) {
        window.location.href = "login.html";
      } else {
        userId = user.uid;
        const q = query(collection(db, "chats", userId, "messages"), orderBy("timestamp"));
        onSnapshot(q, (snapshot) => {
          chatBox.innerHTML = "";
          messages = [];
          snapshot.forEach(doc => {
            const msg = doc.data();
            messages.push(msg);
            addMessageBubble(msg);
          });
        });
      }
    });

    sendBtn.onclick = async () => {
      const message = inputBox.value.trim();
      if (!message) return;
      inputBox.value = "";

      await addDoc(collection(db, "chats", userId, "messages"), {
        from: "user",
        text: message,
        timestamp: new Date()
      });

      const res = await fetch("https://steveai-production.up.railway.app/chat", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ message })
      });
      const data = await res.json();
      await addDoc(collection(db, "chats", userId, "messages"), {
        from: "bot",
        text: data.content || "No response",
        timestamp: new Date()
      });
    };

    logoutBtn.onclick = async () => {
      await signOut(auth);
      window.location.href = "login.html";
    };

    exportBtn.onclick = async () => {
      const text = messages.map(m => `${m.from === "user" ? "üßë You" : "ü§ñ SteveAI"}: ${m.text}`).join("\n\n");
      const blob = new Blob([text], { type: "text/plain" });
      const link = document.createElement("a");
      link.href = URL.createObjectURL(blob);
      link.download = "steveai_chat_history.txt";
      link.click();
    };
  </script>
</body>
</html>
